{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.5",
    "parameters": { 
        "newStorageAccount": {
            "type":"string",
            "metadata": {
                "description" : "Unique DNS name of the Storage Account for Azure"
            }      
        },
        "storageAccountType": {
          "type": "string",
          "defaultValue": "Standard_LRS",
          "allowedValues": [
            "Standard_LRS",
            "Standard_GRS",
            "Standard_RAGRS",
            "Standard_ZRS",
            "Premium_LRS",
            "Premium_ZRS",
            "Premium_GRS",
            "Premium_RAGRS"
          ],
          "metadata": {
            "description":"Storage type for the VM"
          }
        },
        "location": {
          "type": "string",
          "defaultValue": "[resourceGroup().location]",
          "metadata":{
            "description": "Location of all resources"
          }
        },
        "adminUsername": {
          "type": "string",
          "metadata": {
            "description":"Username for VM's admin account"
          }
        },
        "adminPassowrd" : {
          "type": "securestring",
          "minLength": 8,
          "metadata": {
            "description": "Password for VM's admin account.**use Azure Keyvault**"
          }
        },
        "dnsNameForPublicIP": {
          "type": "string",
          "metadata": {
            "description": "Unique DNS name for Public IP of VM"
          }
        },
        "vmSize": {
            "type": "string",
            "defaultValue": "Basic_A0",
            "allowedValues": [
                "Basic_A0",
                "Standard_A0",
                "Standard_A1",
                "Standard_A2",
                "Standard_A3"
            ]
        },
        "vmName": {
          "type": "string",
          "defaultValue": "[concat('vm','ResourceGroup().name')]",
          "metadata": {
            "desctription": "Name for Azure Virtual Machine"
          }

        }


    },
    "variables": { 
      "IpAddressPrefix": "172.16.0.0/16",
      "SubnetPrefix":"172.16.6.0/24",
      "SubnetName":"[concat(parameters('vmName'),'vmsubnet')]",
      "VirtualNetworkName":"[concat(parameters('vmName'),'myVNET')]",
      "networkInterface":"vmNic",
      "VnetId":"[resourceId('Microsoft.Network/virtualNetworks',variables('VirtualNetworkName'))]",
      "SubnetRef": "[concat(variables('VnetId'),'/subnets/',variables('SubnetName'))]",
      "publicIpAddressType":"dynamic",
      "osImagePublisher": "Canonical",
      "osImageOffer": "UbuntuServer",
      "osImageSku": "18.04-LTS",
      "osImageVersion": "Latest",
      "installUnifitemplateUri":"https://raw.githubusercontent.com/TheComaCorpse/unifi_ubuntu_arm_template/master/deploy/unifi-install-ubuntu.sh"
      },
    "resources": [
      {
        "type": "Microsoft.Storage/storageAccounts",
        "name": "[parameters('newStorageAccount')]" ,
        "apiVersion": "2017-10-01",
        "location":"[parameters('location')]",
        "kind": "StorageV2",
        "sku": {
          "name": "[parameters('storageAccountType')]"
        }
      },
      {
        "type":"Microsoft.Network/publicIPAddresses",
        "name":"[parameters('dnsNameForPublicIP')]",
        "apiVersion": "2017-10-01",
        "location":"[parameters('location')]",
        "properties":{
          "publicIPAllocationMethod":"[variables('publicIpAddressType')]",
          "dnsSettings":{
            "domainNameLabel": "[parameters('dnsNameForPublicIP')]"
          }

        }
      },
      {
        "type":"Microsoft.Network/virtualNetworks",
        "name":"[variables('VirtualNetworkName')]",
        "apiVersion": "2017-10-01",
        "location": "[parameters('location')]",
        "properties":{
          "addressSpace":{
            "addressPrefixes":[
              "[variables('IpAddressPrefix')]"
            ]
          },
          "subnets":[
            {
              "name": "[variables('SubnetName')]",
              "properties":{
                "addressPrefix": "[variables('SubnetPrefix')]"
              }
            }
          ]
        }
      },
      {
        "type": "Microsoft.Network/networkInterfaces",
        "name": "[variables('networkInterface')]",
        "apiVersion": "2017-10-01",
        "dependsOn": [
          "[Concat('Microsoft.Network/publicIPAddresses/',parameters('dnsNameForPublicIP'))]",
          "[Concat('Microsoft.Network/virtualNetworks/',variables('virtualNetworkName'))]"
          ],
        "location" : "[parameters('location')]",
        "properties":{
          "ipConfigurations":[
            {
              "name": "ipconfig",
              "properties":{               
                "publicIPAddress":{
                  "id": "[resourceId('Microsoft.Network/publicIPAddresses',parameters('dnsNameForPublicIP'))]"
                },
                "privateIPAllocationMethod":"Dynamic",
                "subnet" :{
                  "id": "[variables('SubnetRef')]"
                }
              }
            }
          ]
        }
      },
      {
        "type": "Microsoft.Compute/virtualMachines",
        "name": "[parameters('vmName')]",
        "apiVersion": "2017-12-01",
        "location": "[parameters('location')]",
        "dependsOn": [
          "[Concat('Microsoft.Storage/storageAccounts/',parameters('newStorageAccount'))]",
          "[Concat('Microsoft.Network/networkInterfaces/',variables('networkInterface'))]"
        ],
        "properties":{
          "hardwareProfile":{
            "vmSize":"[parameters('vmSize')]" 
          },
          "osProfile":{
            "computerName": "[concat(parameters('vmNAme'))]",
            "adminUsername": "[parameters('adminUsername')]",
            "adminPassword": "[parameters('adminPassowrd')]"
            },     
          "storageProfile":{
            "imageReference":{
              "publisher": "[variables('osImagePublisher')]",
              "offer": "[variables('osImageOffer')]",
              "sku": "[variables('osImageSku')]",
              "version": "[variables('osImageVersion')]"
            },                    
          "osDisk": {
            "osType":"Linux",
            "managedDisk":{
              "storageAccountType":"[parameters('storageAccountType')]"
            },
            "createOption": "FromImage",
            "diskSizeGB": 32
          },
          "dataDisks":[
            {
              "lun": 1,
              "name": "dump",
              "createOption":"Empty",
              "diskSizeGB": 32,
              "managedDisk":{
                "storageAccountType":"Standard_LRS"
              }
            }
          ]      
        },
          "networkProfile": {
            "networkInterfaces" :[
              {
                "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterface'))]"  
              }                  
            ]
          },
          "diagnosticsProfile": {
            "bootDiagnostics": {
              "enabled": true,
              "storageUri":"[concat('http://',parameters('newStorageAccount'),'.blob.core.windows.net')]"
            }
          }
        }
      },
      {
        "type": "Microsoft.Compute/virtualMachines/extensions",
        "name": "[concat(parameters('vmName'),'/installunifi')]",
        "apiVersion": "2017-12-01",
        "location": "[parameters('location')]",
        "dependsOn": [
          "[Concat('Microsoft.Compute/virtualMachines/',parameters('vmName'))]"
        ],
        "properties":{
          "publisher": "Microsoft.Azure.Extensions",
          "type": "CustomScript",
          "typeHandlerVersion": "2.0",
          "autoUpgradeMinorVersion": true,
          "settings": {
            "fileUris": [
              "[variables('installUnifitemplateUri')]"
            ],
            "commandToExecute": "sh unifi-install-ubuntu.sh"
          }
        }
      }
    ],
    "outputs": {  

    }
}